<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ReviewScope - ë¶„ì„ ê²°ê³¼</title>
    
    <!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ (style.css) -->
    <link href="/style.css" rel="stylesheet">
    
    <!-- [ë¼ì´ë¸ŒëŸ¬ë¦¬] Chart.js (ì°¨íŠ¸ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- [ë¼ì´ë¸ŒëŸ¬ë¦¬] Marked.js (ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ë§ˆí¬ë‹¤ìš´ ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ (ì—¬ê¸°ì„œë§Œ ì“°ì´ë¯€ë¡œ ì¸ë¼ì¸ ì •ì˜) */
        .markdown-body {
            line-height: 1.7;
            color: #e0e0e0;
            font-size: 15px;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #fff;
        }
        .markdown-body h2 { border-bottom: 1px solid #444; padding-bottom: 5px; }
        .markdown-body ul { padding-left: 20px; margin-bottom: 15px; }
        .markdown-body li { margin-bottom: 5px; }
        .markdown-body strong { color: #00E0C6; } /* ê°•ì¡°ìƒ‰ (ë¯¼íŠ¸) */
        .markdown-body a { color: #6bb0ff; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <!-- [1] ì¢Œì¸¡ ë©”ë‰´ -->
    <nav class="left-sidebar">
        <div class="brand">Review<span>Scope</span></div>
        <ul class="menu-list">
            <a href="/" class="menu-item">ğŸ  í™ˆ ëŒ€ì‹œë³´ë“œ</a>
            <li class="menu-item active">ğŸ“Š ì‹¬ì¸µ ë¶„ì„</li>
            <li class="menu-item">âš™ï¸ ì„¤ì •</li>
        </ul>
    </nav>

    <!-- [2] ì¤‘ì•™ ë©”ì¸ ì˜ì—­ -->
    <main class="main-container">
        <!-- ìƒë‹¨ë°” -->
        <header class="top-bar">
            ğŸ” &nbsp; <span th:text="${keyword}">í‚¤ì›Œë“œ</span> ë¶„ì„ ë¦¬í¬íŠ¸
        </header>

        <div class="feed-area">
            
            <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div th:if="${error}" style="background:rgba(255,75,75,0.1); color:#ff4b4b; padding:20px; border-radius:12px; margin-bottom:20px;">
                âš ï¸ <span th:text="${error}">ì—ëŸ¬ ë°œìƒ</span>
            </div>

            <div th:if="${error} == null">
                
                <!-- [New] AI ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ ì„¹ì…˜ (Insight íƒ€ì…ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
                <!-- th:eachë¡œ ì „ì²´ ë¦¬ë·° ì¤‘ 'Insight' íƒ€ì…ì„ ì°¾ìŒ -->
                <div th:each="report : ${allReviews}" th:if="${report.sentiment == 'Insight'}" class="content-card">
                    <h2 style="margin-bottom: 15px; font-size: 20px; color: var(--accent);">ğŸ“‘ AI ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ</h2>
                    
                    <!-- ë§ˆí¬ë‹¤ìš´ì´ ë Œë”ë§ë  ê³µê°„ -->
                    <div class="markdown-body" th:id="'report-content-' + ${reportStat.index}"></div>
                    
                    <!-- ì›ë³¸ ë§ˆí¬ë‹¤ìš´ ë°ì´í„° (ìˆ¨ê¹€ ì²˜ë¦¬) -->
                    <textarea th:id="'raw-markdown-' + ${reportStat.index}" style="display:none;" th:text="${report.summary}"></textarea>
                    
                    <!-- ë Œë”ë§ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ -->
                    <script th:inline="javascript">
                        (function() {
                            const index = [[${reportStat.index}]];
                            const rawText = document.getElementById('raw-markdown-' + index).value;
                            const targetDiv = document.getElementById('report-content-' + index);
                            
                            // Marked.jsë¡œ ë³€í™˜í•˜ì—¬ ì‚½ì…
                            targetDiv.innerHTML = marked.parse(rawText);
                        })();
                    </script>
                </div>


                <!-- 1. ê¸ì •/ë¶€ì • ì°¨íŠ¸ ì¹´ë“œ -->
                <div class="content-card">
                    <h2 style="margin-bottom: 15px; font-size: 18px;">ğŸ˜Š ê¸ì • vs ë¶€ì • ì—¬ë¡  ë¶„í¬</h2>
                    <div class="big-chart-box">
                        <!-- ì°¨íŠ¸ ì˜ì—­ -->
                        <div class="chart-wrapper">
                            <canvas id="chart"></canvas>
                        </div>
                        
                        <!-- ë²”ë¡€ ì˜ì—­ -->
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="dot" style="background: var(--accent);"></div>
                                <span>ê¸ì •: <strong th:text="${#lists.size(positives)} + 'ê°œ'">0ê°œ</strong></span>
                            </div>
                            <div class="legend-item">
                                <div class="dot" style="background: var(--accent-red);"></div>
                                <span>ë¶€ì •: <strong th:text="${#lists.size(negatives)} + 'ê°œ'">0ê°œ</strong></span>
                            </div>
                            <div class="legend-item">
                                <div class="dot" style="background: #A0A0A0;"></div>
                                <span>ì „ì²´ ë°ì´í„°: <strong th:text="${totalCount} + 'ê±´'">0ê±´</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ê°œë³„ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ (ì¢Œìš° 2ë‹¨) -->
                <div class="content-card">
                    <h3 style="font-size:18px; margin-bottom: 15px;">ğŸ“¢ ê°œë³„ ë¦¬ë·° ìš”ì•½</h3>
                    
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        
                        <!-- ê¸ì • ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
                        <div style="flex: 1; min-width: 300px; background: rgba(0, 224, 198, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(0, 224, 198, 0.2);">
                            <h4 style="color: var(--accent); margin-bottom: 15px; border-bottom: 1px solid rgba(0,224,198,0.2); padding-bottom: 10px;">
                                ğŸ˜Š ê¸ì •ì  ì˜ê²¬
                            </h4>
                            <ul style="list-style: none; padding: 0;">
                                <li th:each="review : ${positives}" style="margin-bottom: 15px;">
                                    <a th:href="${review.link}" target="_blank" style="text-decoration: none; color: inherit; display: block;">
                                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 14px;" th:text="${review.title}">ì œëª©</div>
                                        <div style="font-size: 13px; color: #b0b0b0; white-space: pre-line; word-break: break-word; line-height: 1.5;" 
                                             th:text="${review.summary}">ë‚´ìš©...</div>
                                    </a>
                                </li>
                                <li th:if="${#lists.isEmpty(positives)}" style="color: #666; font-size: 13px; text-align: center; padding: 20px;">
                                    ê¸ì • ë¦¬ë·° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                                </li>
                            </ul>
                        </div>

                        <!-- ë¶€ì • ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
                        <div style="flex: 1; min-width: 300px; background: rgba(255, 75, 75, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 75, 75, 0.2);">
                            <h4 style="color: var(--accent-red); margin-bottom: 15px; border-bottom: 1px solid rgba(255,75,75,0.2); padding-bottom: 10px;">
                                ğŸ˜¡ ë¶€ì •ì  ì˜ê²¬
                            </h4>
                            <ul style="list-style: none; padding: 0;">
                                <li th:each="review : ${negatives}" style="margin-bottom: 15px;">
                                    <a th:href="${review.link}" target="_blank" style="text-decoration: none; color: inherit; display: block;">
                                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 14px;" th:text="${review.title}">ì œëª©</div>
                                        <div style="font-size: 13px; color: #b0b0b0; white-space: pre-line; word-break: break-word; line-height: 1.5;" 
                                             th:text="${review.summary}">ë‚´ìš©...</div>
                                    </a>
                                </li>
                                <li th:if="${#lists.isEmpty(negatives)}" style="color: #666; font-size: 13px; text-align: center; padding: 20px;">
                                    ë¶€ì • ë¦¬ë·° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div> <!-- End of error null check -->
        </div>
    </main>

    <!-- [3] ìš°ì¸¡ ì‚¬ì´ë“œë°” -->
    <aside class="right-sidebar">
        <div class="widget-card">
            <div class="widget-title">ğŸ’¡ Tip</div>
            <p style="font-size: 13px; color: #888; line-height: 1.6;">
                'ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ'ëŠ” AIê°€ ìˆ˜ì§‘ëœ ëª¨ë“  ë¦¬ë·°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•œ ì‹¬ì¸µ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.<br><br>
            </p>
        </div>
    </aside>

    <!-- [ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸] -->
    <script th:inline="javascript" th:if="${error} == null">
        /* Thymeleaf ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸° */
        const positiveCount = [[${#lists.size(positives)}]];
        const negativeCount = [[${#lists.size(negatives)}]];
        const total = [[${totalCount}]];
        
        // ì¤‘ë¦½ì€ ì „ì²´ì—ì„œ ê¸/ë¶€ë¥¼ ëº€ ê°’ (ë‹¨, Insight ë³´ê³ ì„œëŠ” ì¹´ìš´íŠ¸ì—ì„œ ì œì™¸í•˜ëŠ” ë³´ì • í•„ìš”í•  ìˆ˜ ìˆìŒ)
        let neutralCount = total - positiveCount - negativeCount;
        if (neutralCount < 0) neutralCount = 0;

        const ctx = document.getElementById('chart').getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ê¸ì •', 'ë¶€ì •', 'ê¸°íƒ€/ì¤‘ë¦½'],
                datasets: [{
                    data: [positiveCount, negativeCount, neutralCount],
                    backgroundColor: ['#00E0C6', '#FF4B4B', '#444444'], // ìƒ‰ìƒ
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%', // ë„ë„› ë‘ê»˜ ì¡°ì ˆ
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) { label += ': '; }
                                let value = context.raw;
                                let percentage = Math.round((value / total) * 100) + '%';
                                return label + value + 'ê°œ (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>


